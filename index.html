<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>تسجيل الدخول</title>
<style>
body {
  font-family: 'Segoe UI', Tahoma, sans-serif;
  background:#111;
  color:white;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  margin:0;
}
.login-box {
  background:#1f1f1f;
  padding:30px;
  border-radius:12px;
  box-shadow:0 4px 20px rgba(0,0,0,0.7);
  width:320px;
  position: relative;
}
.login-box h2 { text-align:center; margin-bottom:10px; }
.network-status { text-align:center; margin-bottom:15px; font-weight:bold; }
.network-strong { color:#4caf50; }
.network-weak { color:#ffc107; }
.network-off { color:#ff4c4c; }
.form-group { margin-bottom:15px; }
label { display:block; margin-bottom:5px; }
input { width:100%; padding:10px; border-radius:6px; border:none; background:#222; color:white; }
button { width:100%; padding:12px; background:#2575fc; border:none; border-radius:8px; color:white; font-weight:bold; cursor:pointer; }
button:hover { opacity:0.9; }
button:disabled { opacity:0.6; cursor:not-allowed; }
.error-msg { color:#ff4c4c; text-align:center; margin-top:10px; }
.success-msg { color:#4caf50; text-align:center; margin-top:10px; }
/* Spinner */
#loading {
  display:none;
  position:absolute;
  top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,0.7);
  justify-content:center;
  align-items:center;
  border-radius:12px;
  z-index:1000;
}
.spinner {
  border:4px solid #f3f3f3;
  border-top:4px solid #2575fc;
  border-radius:50%;
  width:40px;
  height:40px;
  animation:spin 1s linear infinite;
}
@keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
</style>
</head>
<body>

<div class="login-box">
<h2>تسجيل الدخول</h2>
<div class="network-status" id="networkStatus">التحقق من الشبكة...</div>

<div class="form-group">
<label>اسم المستخدم:</label>
<input type="text" id="username" placeholder="أدخل اسم المستخدم">
</div>
<div class="form-group">
<label>مفتاح الدخول:</label>
<input type="text" id="key" placeholder="أدخل مفتاح الاشتراك">
</div>
<button id="loginBtn">دخول</button>

<p class="error-msg" id="errorMsg"></p>
<p class="success-msg" id="successMsg"></p>

<div id="loading">
    <div class="spinner"></div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

// إعداد Firebase
const firebaseConfig = {
apiKey: "AIzaSyAr_v3kF12qSNko0B6OTVCADZuzSOxn1lw",
authDomain: "fars000911111.firebaseapp.com",
databaseURL: "https://fars000911111-default-rtdb.firebaseio.com",
projectId: "fars000911111",
storageBucket: "fars000911111.appspot.com",
messagingSenderId: "74964466448",
appId: "1:74964466448:web:18d91ccf891edab4634395",
measurementId: "G-H2K9WGRR0X"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// تحديث حالة الشبكة
const networkStatusEl = document.getElementById('networkStatus');
function updateNetworkStatus() {
    if(!navigator.onLine){
        networkStatusEl.textContent="لا يوجد اتصال بالإنترنت";
        networkStatusEl.className="network-status network-off";
    } else if(navigator.connection){
        const speed=navigator.connection.effectiveType;
        networkStatusEl.textContent=(speed==="4g"||speed==="wifi")?"اتصال قوي":"اتصال ضعيف";
        networkStatusEl.className="network-status "+((speed==="4g"||speed==="wifi")?"network-strong":"network-weak");
    } else{
        networkStatusEl.textContent="متصل بالإنترنت";
        networkStatusEl.className="network-status network-strong";
    }
}
window.addEventListener('online', updateNetworkStatus);
window.addEventListener('offline', updateNetworkStatus);
updateNetworkStatus();

// التعامل مع الزر
document.getElementById('loginBtn').addEventListener('click', async ()=>{
    const username=document.getElementById('username').value.trim();
    const key=document.getElementById('key').value.trim();
    const errorMsg=document.getElementById('errorMsg');
    const successMsg=document.getElementById('successMsg');
    const loginBtn=document.getElementById('loginBtn');
    const loading=document.getElementById('loading');

    errorMsg.textContent="";
    successMsg.textContent="";

    if(!username || !key){
        errorMsg.textContent="الرجاء إدخال اسم المستخدم والمفتاح!";
        return;
    }
    if(!navigator.onLine){
        errorMsg.textContent="لا يوجد اتصال بالإنترنت!";
        return;
    }

    // مؤثر الانتظار وتفعيل/تعطيل الزر
    loading.style.display="flex";
    loginBtn.disabled=true;

    try{
        const snapshot = await get(ref(db,'subscribers'));
        if(snapshot.exists()){
            const data = snapshot.val();
            let found=false;
            for(const id in data){
                const sub = data[id];
                if(sub.name===username && sub.key===key){
                    found=true;
                    const now = new Date();
                    const endTime = new Date(sub.endTime);
                    if(now > endTime){
                        errorMsg.textContent="انتهت مدة الاشتراك، يرجى تجديده";
                    } else {
                        successMsg.textContent="تم تسجيل الدخول بنجاح!";
                        setTimeout(()=>window.location.href="dashboard.html",1000);
                    }
                    break;
                }
            }
            if(!found) errorMsg.textContent="المفتاح غير صحيح أو تم حذفه!";
        } else{
            errorMsg.textContent="لا يوجد مشتركين في قاعدة البيانات!";
        }
    } catch(err){
        console.error(err);
        errorMsg.textContent="حدث خطأ أثناء التحقق!";
    } finally{
        loading.style.display="none";
        loginBtn.disabled=false;
    }
});
</script>

</body>
</html>
